[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log
logfile_maxbytes=0
pidfile=/tmp/supervisord.pid
childlogdir=/var/log/supervisor

# ============================================================
# BUN SERVICE (Next.js / frontend)
# ============================================================

[program:bun]
command=bash -c "/app/scripts/start-bun.sh 2>&1 | sed -u 's/^/[BUN] /'"
directory=/app/project
autostart=true
autorestart=true
startretries=3
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
redirect_stderr=true
environment=NODE_ENV="%(ENV_KOSUKE_MODE)s",KOSUKE_MODE="%(ENV_KOSUKE_MODE)s",KOSUKE_BUN_DIR="%(ENV_KOSUKE_BUN_DIR)s",KOSUKE_BUN_DB_MIGRATE_CMD="%(ENV_KOSUKE_BUN_DB_MIGRATE_CMD)s",KOSUKE_BUN_DB_SEED_CMD="%(ENV_KOSUKE_BUN_DB_SEED_CMD)s"
priority=10

# ============================================================
# PYTHON SERVICE (FastAPI / engine) - Optional
# ============================================================

[program:python]
command=bash -c "/app/scripts/start-python.sh 2>&1 | sed -u 's/^/[PYTHON] /'"
directory=/app/project
autostart=true
autorestart=true
startretries=3
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
redirect_stderr=true
environment=KOSUKE_MODE="%(ENV_KOSUKE_MODE)s",KOSUKE_PYTHON_DIR="%(ENV_KOSUKE_PYTHON_DIR)s"
priority=10

# ============================================================
# KOSUKE CLI AGENT (Fastify server via kosuke serve)
# ============================================================

[program:agent]
command=bash -c "/app/scripts/start-agent.sh 2>&1 | tee -a /var/log/supervisor/agent.log | sed -u 's/^/[AGENT] /'"
directory=/app/project
autostart=true
autorestart=true
startretries=3
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
redirect_stderr=true
environment=PORT="%(ENV_KOSUKE_AGENT_PORT)s",PROJECT_DIR="/app/project",ANTHROPIC_API_KEY="%(ENV_ANTHROPIC_API_KEY)s",ANTHROPIC_MODEL="%(ENV_ANTHROPIC_MODEL)s",ORG_ID="%(ENV_KOSUKE_ORG_ID)s",PROJECT_ID="%(ENV_KOSUKE_PROJECT_ID)s",SESSION_ID="%(ENV_KOSUKE_SESSION_ID)s",LANGFUSE_SECRET_KEY="%(ENV_LANGFUSE_SECRET_KEY)s",LANGFUSE_PUBLIC_KEY="%(ENV_LANGFUSE_PUBLIC_KEY)s",LANGFUSE_BASE_URL="%(ENV_LANGFUSE_BASE_URL)s"
priority=5
